# Adapted from details provided in article written by Harsh Shah that can be viewed at:
#   https://harshshah8996.medium.com/configure-nginx-for-a-production-environment-be0e02a3d9e8

# SSL Configurations were adapted from those found at https://beguier.eu/nicolas/articles/nginx-tls-security-configuration.html
# and the article provided by Harsh Shah listed above.

worker_processes auto;

events {
    worker_connections 1024; # Each worker can handle 1024 simultaneous connections
    use epoll; # (Optional) On Linux, this is used automatically
    accept_mutex on;
    multi_accept on; # (Optional) Allows a worker to accept all new connections at once
}

http {
    sendfile on;
    default_type application/octet-stream;
    # Define a global limit on the number of requests that can be placed by a unique IP address at any given second
    limit_req_zone $binary_remote_addr zone=one:80m rate=80r/s;

    # Define a global limit on the maximum number of connections that can be opened by a unique IP address at any given time
    limit_conn_zone $binary_remote_addr zone=addr:80m;

    # Distribute resource load over multiple upstream servers when possible to reduce traffic load on nginx server
    # Destination server for Flask Client Service
    upstream flask_app_server {
        server flask-app:${APP_PORT} fail_timeout=0;
    }

    # Destination server for Vault Service
    upstream vault_server {
        server vault-store:${VAULT_PORT} fail_timeout=0;
    }

    # Redirect all requests to secure server
    server {
        listen 80;

        # Prevent revealing current version of NGINX server or other hardware/software in error details
        # to avoid potential exploitation of known vulnerablities
        access_log off;
        server_tokens off;

        # Set default data configuration settings
        sendfile on;
        default_type application/octet-stream;


        # Enable data compression using gzip to improve network performance
        gzip on;
        gzip_static on;
        gzip_http_version 1.1;
        gzip_disable      "MSIE [1-6]\.";
        gzip_min_length   256;
        gzip_vary         on;
        gzip_proxied any;
        gzip_types
            application/atom+xml
            application/javascript
            application/x-javascript
            application/json
            application/rss+xml
            application/vnd.ms-fontobject
            application/x-font-ttf
            application/x-web-app-manifest+json
            application/xhtml+xml
            application/xml
            font/opentype
            image/svg+xml
            image/x-icon
            text/xml
            text/css
            text/plain
            text/x-component
            text/javascript;
        gzip_comp_level   7;

        # Define timeout settings to reduce resource constraints placed by slow connections
        keepalive_timeout 5s;
        keepalive_requests 80;
        send_timeout 30s;

        # Redirect to appropriate Docker service based on URL
        return 301 https://$host$request_uri;
    }

    # Secure server that employs TLS protocols
    server {
        listen 443 ssl;

        # Prevent revealing current version of NGINX server or other hardware/software in error logs
        # to avoid potential exploitation of known vulnerablities
        access_log off;
        server_tokens off;

        # Enable TLS protocols instead of SSL for enhanced security
        ssl_protocols TLSv1.2 TLSv1.3;

        # Provide self-signed certificate for local use
        # NOTE: If using CA certificate use OCSP Stapling for continued handshake verification
        ssl_certificate /etc/ssl/certs/vault-cert.pem;
        ssl_certificate_key /etc/ssl/private/vault-key.pem;

        # Enable session caching over SSL but disable use of session tickets
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_session_tickets off;

        # Increase default size to support transmission of larger file sizes 
        client_max_body_size 16G;

        # Disable proxy request and response buffering by receiving secure server
        proxy_buffering off;
        proxy_request_buffering off;

        # Enforce use of server-provided list of ssl ciphers
        ssl_prefer_server_ciphers on;

        # Provide curated list of ssl ciphers to be used (https://beguier.eu/nicolas/articles/nginx-tls-security-configuration.html)
        ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';

        # Use HSTS response headers to enforce strict use of HTTPS for site access (set for one year)
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";

        # Prevent use of Clickjacking as mentioned at https://developer.mozilla.org/en-US/docs/HTTP/X-Frame-Options
        add_header X-Frame-Options DENY;

        # Prevent MIME type sniffing (prevent responses with MIME types other than deliberately configured type)
        add_header X-Content-Type-Options nosniff;

        # Ensure default Cross-Site Scripting filter is enabled
        add_header X-XSS-Protection "1; mode=block";

        # In the case the above XSS filter fails, provides added protection against XSS attack by blocking site within an inframe 
        # (https://beguier.eu/nicolas/articles/nginx-tls-security-configuration.html)
        add_header Content-Security-Policy "frame-ancestors 'self';";


        # Integrated Flask Application Service URI
        location / {
            # Limit to 80 bursting requests to be placed on vault service from a unique IP address
            limit_req zone=one burst=80;

            # Limit to 80 connections to be opened to vault service from a unique IP address
            limit_conn addr 80;

            # Enable buffering for use on client service
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_read_timeout 86400;
            proxy_buffer_size           128k;
            proxy_buffers               4 256k;
            proxy_busy_buffers_size     256k;
            index index.html;

            # OPTIONAL: Enable client-side caching of static content 
            # location ~* \.
            # (?:ico|gif|jpe?g|png|htc|xml|otf|ttf|eot|woff|woff2|svg)$ {
            #     expires 1d;
            #     access_log off;
            #     log_not_found off;
            #     add_header Cache-Control private;
            #     open_file_cache max=3000 inactive=120s;
            #     open_file_cache_valid 120s;
            #     open_file_cache_min_uses 4;
            #     open_file_cache_errors on;
            # }

            # location ~*  \.(css|js|html)$ {
            #     expires 12h;
            #     access_log on;
            #     add_header Cache-Control public;
            # }

            proxy_pass http://flask_app_server;
        }


        # HashiCorp Vault Client Service URI
        location /vault {

            # Limit to 80 bursting requests to be placed on backend API service from a unique IP address
            limit_req zone=one burst=80;

            # Limit to 80 connections to be opened to backend API service from a unique IP address
            limit_conn addr 80;

            rewrite ^/vault/(.*) /$1 break; # Use regex to ensure flexibility of base API URI
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Enable buffering for use on vault service
            proxy_read_timeout 86400;
            proxy_buffer_size           128k;
            proxy_buffers               4 256k;
            proxy_busy_buffers_size     256k;
            proxy_pass https://vault_server;
        }
    }
}